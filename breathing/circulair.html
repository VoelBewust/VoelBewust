<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Circulaire Ademhaling</title>

<style>
  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background-color: #7abf3f;
    font-family: sans-serif;
  }

  .controls {
    position: fixed;
    top: 30px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .controls label {
    color: white;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .controls label span {
    display: inline-block;
    width: 180px;
    text-align: right;
  }

  .controls input[type="number"] {
    width: 80px;
    padding: 4px 8px;
    font-size: 14px;
  }

  .controls button {
    margin-top: 10px;
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    background-color: white;
    border: none;
    border-radius: 4px;
    font-weight: bold;
  }

  .controls button:hover {
    background-color: #f0f0f0;
  }

  .circle-container {
    position: relative;
    width: 320px;
    height: 320px;
    margin-top: 60px;
  }

  svg {
    transform: rotate(-90deg); /* Start bovenaan */
  }

  .breath-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 2em;
    font-weight: bold;
    pointer-events: none;
  }

  .center-timer {
    position: absolute;
    top: calc(50% + 45px);
    left: 50%;
    transform: translateX(-50%);
    color: white;
    font-size: 1.5em;
    font-weight: bold;
  }

  .hidden {
    display: none !important;
  }

  #stopBtn {
    position: fixed;
    top: 30px;
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 16px;
    font-size: 14px;
    cursor: pointer;
    background-color: white;
    border: none;
    border-radius: 4px;
    font-weight: bold;
  }

  #stopBtn:hover {
    background-color: #f0f0f0;
  }
</style>
</head>

<body>

<div class="controls">
  <label>
    <span>Inademen (seconden):</span>
    <input type="number" id="inInput" value="4" min="1">
  </label>
  <label>
    <span>Uitademen (seconden):</span>
    <input type="number" id="outInput" value="4" min="1">
  </label>
  <label>
    <span>Timer (minuten):</span>
    <input type="number" id="timerInput" value="5" min="1">
  </label>
  <button id="startBtn">Start</button>
</div>

<button id="stopBtn" class="hidden">Stop</button>

<div class="circle-container">
  <svg width="320" height="320">
    <circle
      id="circ"
      cx="160" cy="160" r="140"
      stroke="white" stroke-width="10"
      fill="none"
      stroke-linecap="round"
    />
  </svg>

  <div class="breath-text" id="breathText">IN</div>
  <div class="center-timer" id="centerTimer">05:00</div>
</div>

<script>
const circ = document.getElementById("circ");
const breathText = document.getElementById("breathText");
const centerTimer = document.getElementById("centerTimer");

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const controls = document.querySelector(".controls");
const inInput = document.getElementById("inInput");
const outInput = document.getElementById("outInput");
const timerInput = document.getElementById("timerInput");

let animationId;
let totalSeconds;
let remainingSeconds;
let lastPhase = null;
let endSoundPlayed = false;

const circumference = 2 * Math.PI * 140;
circ.style.strokeDasharray = circumference;

// Creëer een zacht geluid met Web Audio API
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

function playTransitionSound() {
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);

  // Zachte toon (A4 = 440Hz)
  oscillator.frequency.value = 440;
  oscillator.type = 'sine';

  // Zachte volume met fade out
  gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.2);
}

function playEndSound() {
  // Speel een dubbele ping bij einde
  const oscillator1 = audioContext.createOscillator();
  const oscillator2 = audioContext.createOscillator();
  const gainNode1 = audioContext.createGain();
  const gainNode2 = audioContext.createGain();

  oscillator1.connect(gainNode1);
  oscillator2.connect(gainNode2);
  gainNode1.connect(audioContext.destination);
  gainNode2.connect(audioContext.destination);

  // Eerste ping (hoger, 880Hz = A5)
  oscillator1.frequency.value = 880;
  oscillator1.type = 'sine';
  gainNode1.gain.setValueAtTime(0.15, audioContext.currentTime);
  gainNode1.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

  // Tweede ping (lager, 660Hz = E5) - iets later
  oscillator2.frequency.value = 660;
  oscillator2.type = 'sine';
  gainNode2.gain.setValueAtTime(0, audioContext.currentTime);
  gainNode2.gain.setValueAtTime(0.15, audioContext.currentTime + 0.15);
  gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

  oscillator1.start(audioContext.currentTime);
  oscillator1.stop(audioContext.currentTime + 0.3);
  oscillator2.start(audioContext.currentTime + 0.15);
  oscillator2.stop(audioContext.currentTime + 0.5);
}

function formatTime(seconds) {
  const m = Math.floor(seconds / 60).toString().padStart(2, "0");
  const s = (seconds % 60).toString().padStart(2, "0");
  return `${m}:${s}`;
}

function startAnimation() {
  cancelAnimationFrame(animationId);

  // Verberg controls, toon stop knop
  controls.classList.add('hidden');
  stopBtn.classList.remove('hidden');

  const inTime = parseFloat(inInput.value);
  const outTime = parseFloat(outInput.value);

  const cycleTime = inTime + outTime;

  totalSeconds = parseInt(timerInput.value) * 60;
  remainingSeconds = totalSeconds;
  endSoundPlayed = false;
  lastPhase = null;

  let startTime = null;

  function animate(timestamp) {
    if (!startTime) startTime = timestamp;
    const elapsed = (timestamp - startTime) / 1000;

    // Timer
    const elapsedSeconds = Math.floor(elapsed);
    remainingSeconds = totalSeconds - elapsedSeconds;
    if (remainingSeconds < 0) remainingSeconds = 0;
    centerTimer.textContent = formatTime(remainingSeconds);

    // Speel eindgeluid en stop als tijd op is
    if (remainingSeconds === 0 && !endSoundPlayed) {
      playEndSound();
      endSoundPlayed = true;
      stopAnimation();
      return;
    }

    // Progress in cycle (0 → 1)
    const cycleProgress = (elapsed % cycleTime) / cycleTime;

    let phaseProgress;
    let offset;
    let currentPhase;

    if (cycleProgress < inTime / cycleTime) {
      // IN
      currentPhase = "IN";
      breathText.textContent = "IN";
      phaseProgress = cycleProgress / (inTime / cycleTime);
      offset = circumference - circumference * phaseProgress; // 0% → 100%
    } else {
      // UIT
      currentPhase = "UIT";
      breathText.textContent = "UIT";
      phaseProgress = (cycleProgress - inTime / cycleTime) / (outTime / cycleTime);
      offset = circumference * phaseProgress; // 100% → 0%
    }

    // Speel geluid bij overgang naar nieuwe fase
    if (currentPhase !== lastPhase && lastPhase !== null) {
      playTransitionSound();
    }
    lastPhase = currentPhase;

    circ.style.strokeDashoffset = offset;
    animationId = requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}

function stopAnimation() {
  cancelAnimationFrame(animationId);
  lastPhase = null;
  endSoundPlayed = false;
  centerTimer.textContent = formatTime(parseInt(timerInput.value) * 60);
  circ.style.strokeDashoffset = circumference;
  breathText.textContent = "IN";

  // Verberg stop knop, toon controls
  stopBtn.classList.add('hidden');
  controls.classList.remove('hidden');
}

startBtn.addEventListener("click", startAnimation);
stopBtn.addEventListener("click", stopAnimation);

let wakeLock = null;

async function requestWakeLock() {
  try {
    wakeLock = await navigator.wakeLock.request('screen');
    wakeLock.addEventListener('release', () => {
      console.log('Screen Wake Lock released');
    });
    console.log('Screen Wake Lock active');
  } catch (err) {
    console.error(`${err.name}, ${err.message}`);
  }
}

// Call this when the page loads
requestWakeLock();

</script>
</body>
</html>

